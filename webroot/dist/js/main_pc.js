!function(t){var n={};function a(e){if(n[e])return n[e].exports;var o=n[e]={i:e,l:!1,exports:{}};return t[e].call(o.exports,o,o.exports,a),o.l=!0,o.exports}a.m=t,a.c=n,a.d=function(e,o,t){a.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(o,e){if(1&e&&(o=a(o)),8&e)return o;if(4&e&&"object"==typeof o&&o&&o.__esModule)return o;var t=Object.create(null);if(a.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:o}),2&e&&"string"!=typeof o)for(var n in o)a.d(t,n,function(e){return o[e]}.bind(null,n));return t},a.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(o,"a",o),o},a.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},a.p="",a(a.s=16)}([function(e,o,t){"use strict";var n,a,s,i;o.__esModule=!0,(a=n=n||{})[a.Working=100]="Working",a[a.Stopping=101]="Stopping",(i=s=s||{})[i.VideoSystemUnInit=100]="VideoSystemUnInit",i[i.VideoSystemUnIniting=200]="VideoSystemUnIniting",i[i.VideoSystemInitSucc=300]="VideoSystemInitSucc",i[i.VideoSystemInitFailed=400]="VideoSystemInitFailed";var l=function(){this.AudioRecording=!1,this.VideoChatting=!1,this.VideoSystemStatus=s.VideoSystemUnInit},r=(c.CoreMessageLoopTime=100,c.globalProcessStatus=n.Working,c.protocol="ws://",c.globalBackgroundImg="",c.globalUserID=-1,c.globalPwd="",c.globalMobile=!1,c.globalLoginPage="index.html",c.globalRegisterPage="new.html",c.globalMainPage="main.html",c.NoteglobalVideoSystemStatusObject=new l,c.username="",c.globalFriendsId=[],c.globalMessageArray=[],c.sakdasjdhakd9aqwieyqwieyi="4F637416",c);function c(){}o.GlobalVars2=r,o.audioorvideoWorking=function(){return r.NoteglobalVideoSystemStatusObject.AudioRecording||r.NoteglobalVideoSystemStatusObject.VideoChatting},o.audioWorking=function(){return r.NoteglobalVideoSystemStatusObject.AudioRecording},o.turnOffAudio=function(){r.NoteglobalVideoSystemStatusObject.AudioRecording=!1},o.turnOnAudion=function(){r.NoteglobalVideoSystemStatusObject.AudioRecording=!0},o.turnOffvideo=function(){r.NoteglobalVideoSystemStatusObject.VideoChatting=!1},o.turnOnvideo=function(e){r.NoteglobalVideoSystemStatusObject.VideoChatting=!0},o.isVideoSystemNeedInite=function(){return r.NoteglobalVideoSystemStatusObject.VideoSystemStatus==s.VideoSystemUnInit},o.isVideoSystemIniting=function(){return r.NoteglobalVideoSystemStatusObject.VideoSystemStatus==s.VideoSystemUnIniting},o.isVideoSystemInitSucc=function(){return r.NoteglobalVideoSystemStatusObject.VideoSystemStatus!=s.VideoSystemInitSucc},o.startProcessCoreMessage=function(){r.globalProcessStatus=n.Working},o.stopProcessCoreMessage=function(){r.globalProcessStatus=n.Stopping},o.isProcessCoreMessageWorking=function(){return r.globalProcessStatus==n.Working},o.getOpenWidth=function(){return!0===r.globalMobile?"400px;":"560px;"},o.changeBackground=function(){var e=Math.round(100*Math.random())+1,o=(e%=38).toString()+".jpg";o="../images/bg/img/"+(o=e<10?"0000"+o:"000"+o),r.globalBackgroundImg="url("+o+")",document.getElementsByTagName("body")[0].style.backgroundImage=r.globalBackgroundImg},o.sendMessageToServer=function(e){var o=e.cmd+r.sakdasjdhakd9aqwieyqwieyi+JSON.stringify(e);console.log("send message ",o),r.globalImSocketObject.send(o)}},function(e,o,t){"use strict";o.__esModule=!0;var n=(a.Request_register_code="001",a.Request_login_code="011",a.Request_online_client_info_code="002",a.Response_online_client_info_code="102",a.Response_login_code="111",a.Response_mine_code="121",a.Response_add_friend_list_code="131",a.Request_a_to_server_add_friend_code="032",a.Request_server_to_b_add_friend_code="032",a.Response_server_to_a_add_friend_code="133",a.Request_confirm_add_friend_code="033",a.Request_fetch_friend_code="037",a.Response_server_to_a_fetch_friend_code="137",a.Request_remove_friend_code="039",a.Response_remove_friend_code="139",a.Request_message_code="041",a.Requst_ack_message_code="042",a.Response_message_code="142",a.Response_friend_status_change_code="151",a.Response_friend_info_change_code="152",a.Request_video_chat_a_to_server_code="053",a.Response_video_chat_server_to_a_code="153",a.Request_video_chat_b_to_server_code="054",a.Response_video_chat_server_to_b_code="154",a.Request_client_to_server_video_was_stopped_code="055",a.Response_server_to_client_video_was_stopped_code="155",a.LOGIN_CMD="login",a.OFFER_CMD="offer",a.ANSWER_CMD="answer",a.CANDIDATE_CMD="candidate",a.LEAVE_CMD="leave",a);function a(){}o.GlobalCode=n},function(e,o,t){"use strict";o.__esModule=!0;function n(){}o.RequsetSignin=n;function a(){}o.ResponseAddList=a;function s(){}o.ChatMessage=s;function i(){}o.AckChatMessage=i;function l(){}o.AddFriendRequest=l;function r(){}o.AddFriendResponse=r;function c(){}o.SetFriendStatusResponse=c;function d(){}o.ConfirmAddFriendRequest=d;function u(){}o.RequestFetchFriendInfo=u;function g(){}o.ResponseFetchFriendInfo=g;function b(){}o.ResponseMine=b;function f(){}o.RequestUserRegister=f;function m(){}o.ResponseUserRegister=m;function p(){}o.ResponseSignin=p;function _(){}o.UserInfo=_;function h(){}o.RequestRemoveFriend=h;function y(){}o.ResponseRemoveFriend=y;function v(){}o.RequestVideoChatClosed=v;function S(){}o.VideoChatMsg=S;function C(){}o.LoginWebRtcRoom=C;function V(){}o.Candidate=V;function G(){}o.Answer=G;function w(){}o.Offer=w;function R(){}o.WebRTCJson=R},function(e,o,t){"use strict";o.__esModule=!0;var n=t(0),a=Domain,s=a+":3478",i=a+":3478";var l=(r.uploaderSocketServer=a+":8091",r.ImServer=a+":8090",r.signallingConnectionServer=a+":8888",r.stunServerConfigString='[{ "urls": "stun:'+s+'?transport=udp"   } ,{ "urls": "stun:'+s+'?transport=tcp"   } ,{ "urls": "turn:'+i+'?transport=udp",  "username": "k1",  "credential": "1234567" } ,{ "urls": "turn:'+i+'?transport=tcp",  "username": "k1",  "credential": "1234567" } ] ',r);function r(){}o.GlobalVars=l,"https:"===document.location.protocol&&(n.GlobalVars2.protocol="wss://"),console.log("GlobalVars2.protocol  ",n.GlobalVars2.protocol),l.uploaderSocketServer=n.GlobalVars2.protocol+l.uploaderSocketServer,l.ImServer=n.GlobalVars2.protocol+l.ImServer,l.signallingConnectionServer=n.GlobalVars2.protocol+l.signallingConnectionServer,console.log("GlobalVars.uploaderSocketServer  ",l.uploaderSocketServer),console.log("GlobalVars.ImServer   ",l.ImServer),console.log("GlobalVars.signallingConnectionServer  ",l.signallingConnectionServer)},function(e,o,t){"use strict";o.__esModule=!0;var i=t(0),s=t(1),n=t(2),a=t(3),l=t(5),r=(c.prototype.initFirstVideoChatMsg=function(){this.firstVideoChatInit=!0},c.prototype.cleanFirstVideoChatMsg=function(){this.firstVideoChatInit=!1},c.prototype.isFirstVideoChatInited=function(){return this.firstVideoChatInit},c.prototype.createFirstVideoChat=function(e,o){if(!this.isFirstVideoChatInited()){this.firstVideoChatInit=!0,this.firstVideoChat.localsession=Math.round(1e4*Math.random())+200;var t=$(e).attr("data-json"),n=decodeURIComponent(t),a=JSON.parse(n);this.firstVideoChat.clienta=i.GlobalVars2.globalUserID,this.firstVideoChat.clientb=parseInt(a.id,10),this.firstVideoChat.audiochatonly=o,this.firstVideoChat.cmd=s.GlobalCode.Request_video_chat_a_to_server_code,console.log("createFirstVideoChat ：localsession:",this.firstVideoChat.localsession)}},c.prototype.updateMyFirstVideoChat=function(e){this.firstVideoChatInit=!0,this.firstVideoChat=e},c.prototype.getSingalRequest=function(){if(this.firstVideoChatInit){var e=new n.WebRTCJson;return e.clienta=this.firstVideoChat.clienta,e.clientb=this.firstVideoChat.clientb,e.whoami=i.GlobalVars2.globalUserID,e.localsession=this.firstVideoChat.localsession,e.roomid=this.firstVideoChat.roomid,e.fromavatar=this.firstVideoChat.fromavatar,e.roomtoken=this.firstVideoChat.roomtoken,e.requestid=this.firstVideoChat.requestid,e.sessionid=this.firstVideoChat.sessionid,e}alert("wrong Request")},c.prototype.getSingalVideoChat=function(){if(this.firstVideoChatInit)return this.firstVideoChat;alert("wrong Request")},c.prototype.cleanLocalSession=function(){this.firstVideoChatInit=!1,this.firstVideoChat.localsession=0,this.firstVideoChat.clientb=0,this.firstVideoChat.clientb=0,console.log("cleanLocalSession ：localsession:",this.firstVideoChat.localsession)},c.prototype.equalLocalSession=function(e){return!!this.isFirstVideoChatInited()&&this.firstVideoChat.localsession==e},c);function c(){this.firstVideoChat=new n.VideoChatMsg,this.firstVideoChat.localsession=0,this.firstVideoChatInit=!1,this.snid=Math.round(1e4*Math.random())+200,this.yourConnectionInitFlag=!1,console.log("constructor VideoSystemObj ",this.snid)}o.VideoSystemObj=r;var d=function(){};function u(){d.GlobalVideoSystem.signalSocket=new WebSocket(a.GlobalVars.signallingConnectionServer),d.GlobalVideoSystem.signalSocket.onopen=function(){console.log("user:  connect success. "+a.GlobalVars.signallingConnectionServer+" ");var e=d.GlobalVideoSystem.getSingalRequest();e.type=s.GlobalCode.LOGIN_CMD,w(e)},d.GlobalVideoSystem.signalSocket.onclose=function(e){console.log("webrtc connection closed")},d.GlobalVideoSystem.signalSocket.onmessage=function(o){var e;try{e=JSON.parse(o.data),console.log("got message",o.data)}catch(e){return void console.log("parse json failed",e,"res.data",o.data)}switch(console.log("got ",e.type),e.type){case s.GlobalCode.LOGIN_CMD:d.GlobalVideoSystem.getSingalRequest().clienta==i.GlobalVars2.globalUserID&&V();break;case s.GlobalCode.OFFER_CMD:m(e.offer);break;case s.GlobalCode.ANSWER_CMD:p(e.answer);break;case s.GlobalCode.CANDIDATE_CMD:_(e.candidate);break;default:console.log("unknow command",e)}}}function g(){d.GlobalVideoSystem.yourConnectionInitFlag=!0}function b(){return d.GlobalVideoSystem.yourConnectionInitFlag}function f(){d.GlobalVideoSystem.yourConnectionInitFlag=!1}function m(e){console.log("recvOfferMsg "),console.log("recvOfferMsg yourConnection.setRemoteDescription"),d.GlobalVideoSystem.yourConnection.setRemoteDescription(new RTCSessionDescription(e)),console.log("recvOfferMsg yourConnection.createAnswer"),d.GlobalVideoSystem.yourConnection.createAnswer(function(e){console.log("yourConnection.setLocalDescription (answer)"),d.GlobalVideoSystem.yourConnection.setLocalDescription(e);var o=d.GlobalVideoSystem.getSingalRequest();o.type=s.GlobalCode.ANSWER_CMD,o.answer=e,w(o)},function(e){alert("An error has occurred")})}function p(e){console.log("recvAnswerMsg "),console.log("recvAnswerMsg yourConnection.setRemoteDescription"),d.GlobalVideoSystem.yourConnection.setRemoteDescription(new RTCSessionDescription(e))}function _(e){console.log("recvCandidateMsg"),console.log("recvCandidateMsg yourConnection.addIceCandidate",JSON.stringify(e)),d.GlobalVideoSystem.yourConnection.addIceCandidate(new RTCIceCandidate(e))}function h(){console.log("initVideoSystem"),d.GlobalVideoSystem.callPage=document.querySelector("#call-page"),d.GlobalVideoSystem.hangUpButton=document.querySelector("#hang-up"),d.GlobalVideoSystem.yourVideo=document.querySelector("#yours"),d.GlobalVideoSystem.theirVideo=document.querySelector("#theirs"),$("#call-page").hide(),i.GlobalVars2.globalMobile||d.GlobalVideoSystem.hangUpButton.addEventListener("click",function(){G()})}function y(e){if(console.log("startConnection() 1"),S()){console.log("startConnection() 2");var o=!0;1==e&&(o=!1),navigator.getUserMedia({video:o,audio:{echoCancellation:!0}},function(e){d.GlobalVideoSystem.stream=e,d.GlobalVideoSystem.yourVideo.src=window.URL.createObjectURL(d.GlobalVideoSystem.stream),C()?(console.log("startConnection() 3"),console.log("hasRTCPeerConnection success"),v(d.GlobalVideoSystem.stream)):alert("Sorry, your browser does not support WebRTC.")},function(e){console.log(e)})}else alert("Sorry, your browser does not support WebRTC.")}function v(e){var o={iceServers:JSON.parse(a.GlobalVars.stunServerConfigString),bundlePolicy:"max-bundle"};console.log("setupPeerConnection(stream);"),console.log("yourConnection = new RTCPeerConnection(configuration)",JSON.stringify(o)),d.GlobalVideoSystem.yourConnection=new RTCPeerConnection(o),g(),console.log("yourConnection.addStream(stream);"),d.GlobalVideoSystem.yourConnection.addStream(e),d.GlobalVideoSystem.yourConnection.onaddstream=function(e){d.GlobalVideoSystem.theirVideo.src=window.URL.createObjectURL(e.stream)},d.GlobalVideoSystem.yourConnection.onicecandidate=function(e){if(console.log("yourConnection.onicecandidate",e),e.candidate){var o=d.GlobalVideoSystem.getSingalRequest();o.type=s.GlobalCode.CANDIDATE_CMD,o.candidate=e.candidate,w(o)}},console.log("setupPeerConnection(stream) done;"),u()}function S(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,!!navigator.getUserMedia}function C(){return window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCSessionDescription=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription,window.RTCIceCandidate=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate,!!window.RTCPeerConnection}function V(){d.GlobalVideoSystem.yourConnection.createOffer(function(e){console.log("yourConnection.createOffer(function (offer)");var o=d.GlobalVideoSystem.getSingalRequest();o.type=s.GlobalCode.OFFER_CMD,o.offer=e,w(o),d.GlobalVideoSystem.yourConnection.setLocalDescription(e)},function(e){alert("An error has occurred.")})}function G(){d.GlobalVideoSystem.connectedUser=null,d.GlobalVideoSystem.theirVideo.src=null,d.GlobalVideoSystem.yourVideo.src=null,b()&&(d.GlobalVideoSystem.yourConnection.close(),d.GlobalVideoSystem.yourConnection.onicecandidate=null,d.GlobalVideoSystem.yourConnection.onaddstream=null),f(),void 0!==d.GlobalVideoSystem.signalSocket&&void 0!==d.GlobalVideoSystem.signalSocket.close&&d.GlobalVideoSystem.signalSocket.close();i.GlobalVars2.globalLayImObj.cache();var e=d.GlobalVideoSystem.getSingalRequest();e.iam=i.GlobalVars2.globalUserID,e.cmd=s.GlobalCode.Request_client_to_server_video_was_stopped_code,i.sendMessageToServer(e),d.GlobalVideoSystem.cleanLocalSession(),M(),$("#remotemessage").html("")}function w(e){var o=d.GlobalVideoSystem.signalSocket,t=JSON.stringify(e);console.log("send message to SingalServer ",t),o.send(t)}function R(){$("#call-page").css("position","absolute"),$("#call-page").css("top",0),$("#call-page").css("left",0),$("#call-page").css("background","#ccc");var e=l.getWH(1);$("#call-page")[0].style.cssText+=";width:"+e.w+"px;height:"+e.h+"px";var o=l.findHighestZIndex("div");console.log("max z: ",o," w: ",e.w,NaN,e.h),$("#call-page").css("z-index",o+1),$("#call-page").css("visibility","visible"),$("#call-page").css("background-image",i.GlobalVars2.globalBackgroundImg),$("#call-page").show()}function k(){var e,o,t,n=window.screen.availHeight,a=window.screen.availWidth;console.log("w:"+a.toString()+" h: "+n.toString()),e=.75*(n*=.9),o=.75*(a*=.9),e=parseInt(e.toFixed()),o=parseInt(o.toFixed()),(a*=.9)<(n*=.9)&&(n=a),t=.8*(a=n=parseInt(n.toFixed())),t=parseInt(t.toFixed()),console.log("w:"+a.toString()+" h: "+n.toString()+" w2: "+t.toString());var s='  <table id="call-page"     style=" top:0px; left: 0px; witdth: '+n.toString()+"px; height: "+a.toString()+'px; ">\n\n\n    <table class="page" >\n\n\n        <video id="yours"   autoplay playsinline controls></video>\n        <video id="theirs"  style="  witdth: '+t.toString()+"px; height:"+t.toString()+'px; " autoplay playsinline controls  ></video>\n\n         \n<div id ="remotemessage"></div>    </table>\n</table>';console.log("['"+e.toString()+"px', '"+o.toString()+"px']"),i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:"['"+o.toString()+"px', '"+e.toString()+"px']",shade:.8,btn:["关闭视频"],btnAlign:"c",moveType:1,content:s,yes:function(e,o){G(),i.GlobalVars2.Global_layer.close(e),i.startProcessCoreMessage()}}),$("#theirs").css("width",n.toString()+"px"),$("#theirs").css("height",n.toString()+"px"),$("#yours").css("width","80px"),$("#yours").css("height","80px"),$("#call-page").css("width",o.toString()+"px"),$("#call-page").css("height",e.toString()+"px"),h()}function M(){i.GlobalVars2.globalMobile||($("#micmask").css("z-index",-1),$("#call-page").css("visibility","hidden"),$("#call-page").hide())}o.GlobalVars3=d,o.callVeidoSingalServer=function(e){y((d.GlobalVideoSystem.firstVideoChat=e).audiochatonly)},o.startWebRTCLoop=u,o.initYourConnectionFlag=g,o.checkYourConnectionInitFlag=b,o.cleanYourConnectionInitFlag=f,o.recvOfferMsg=m,o.recvAnswerMsg=p,o.recvCandidateMsg=_,o.initVideoSystem=h,o.recvLoginMsg=function(e){!1===e?alert("Login unsuccessful, please try a different name."):d.GlobalVideoSystem.callPage.style.display="block"},o.startConnection=y,o.setupPeerConnection=v,o.hasUserMedia=S,o.hasRTCPeerConnection=C,o.startPeerConnection=V,o.recvLeaveMsg=G,o.sendMessageToSingalServer=w,o.showCallPage=function(){console.log("showCallPage()"),i.GlobalVars2.globalMobile?k():R()},o.showCallPagePC=R,o.showCallPageMobile=k,o.hideCallPage=M},function(e,a,o){"use strict";a.__esModule=!0;var s,i,t,n,l,r,c=o(3),d=o(0);a.getWH=(t=document,n=t["CSS1Compat"==t.compatMode?"documentElement":"body"],function(e){return{w:n[(e?"client":"scroll")+"Width"],h:e?n.clientHeight:Math.max(n.clientHeight,n.scrollHeight)}}),(r=l=l||{})[r.needInitAudio=100]="needInitAudio",r[r.AudioInitializing=150]="AudioInitializing",r[r.initSuccess=200]="initSuccess",r[r.initFailed=300]="initFailed";var u,g=l.needInitAudio;function b(e){g=l.initSuccess;var o=s.createMediaStreamSource(e);console.log("Media stream created."),i=new Recorder(o),console.log("Recorder initialised."),p(u)}function f(e){console.log("stopRecording(node)",e),i?console.log("stopRecording(node) recorder is ready"):console.log("stopRecording(node) recorder is not ready"),i&&i.stop(),console.log("Stopped recording."),function(o){i&&i.exportWAV(function(e){!function(e,t){var n=new WebSocket(c.GlobalVars.uploaderSocketServer);n.onopen=function(){console.log("user:  connect success"+c.GlobalVars.uploaderSocketServer),n.send(e)},n.onclose=function(e){console.log("user:  connect close",e)},n.onmessage=function(e){console.log(e);var o=JSON.parse(e.data);console.log("message: "+o.path),n.close(),!1===d.GlobalVars2.globalMobile?function(e,o){e.children(".layim-chat-textarea").children()[0].value="audio["+o.path+"]",e.children(".layim-chat-bottom").find(".layim-send-btn").trigger("click")}(t,o):function(e,o){var t=e.children(".layim-chat-send").children();t[0].value="audio["+o.path+"]";var n=$(t[1]);n.offset().left,n.offset().top;3,3;$("body")}(t,o)}}(e,o)})}(e),i.clear()}function m(e){for(var o=document.getElementsByTagName(e),t="0",n=0;n<o.length;n++){var a=document.defaultView.getComputedStyle(o[n],null).getPropertyValue("z-index");Number(a)>Number(t)&&"auto"!=a&&(t=a)}return Number(t)}function p(e){console.log("audioMessage()",e);var o=$(e).attr("data-json"),t=decodeURIComponent(o),n=(JSON.parse(t),$(e).parent().parent());console.log("AudioDeviceNeedInit"),(g===l.needInitAudio?(console.log("AudioDeviceNeedInit true"),0):(console.log("AudioDeviceNeedInit false"),1))?(console.log("AudioDeviceInitializing"),(g===l.AudioInitializing?(console.log("AudioDeviceInitializing true"),0):(console.log("AudioDeviceInitializing false"),1))&&(g===l.initSuccess?d.audioWorking()?(f(n),$("#AudioRecording").hide(),$("#micmask").remove(),d.turnOffAudio()):(d.turnOnAudion(),function(e){$(document.body).append("<div id=\"micmask\"> <img src='../images/bg/mic.png?__inline'></div>"),$("#micmask").css("position","absolute"),$("#micmask").css("top",0),$("#micmask").css("left",0),$("#micmask").css("background","#ccc");var o=a.getWH(1);$("#micmask")[0].style.cssText+=";width:"+o.w+"px;height:"+o.h+"px";var t=m("div");console.log("max z: ",t," w: ",o.w,NaN,o.h),$("#micmask").css("z-index",t+1),$("#micmask").on("click",function(){$("#micmask").remove(),p(e)})}(e),$("#AudioRecording").show(),console.log("startRecording()"),i?console.log("startRecording( ) recorder is ready"):console.log("startRecording( ) recorder is not ready"),i&&i.record(),console.log("Recording...")):alert("no device"))):function(e){console.log("InitUserMediaSystem"),g=l.AudioInitializing;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia,window.URL=window.URL||window.webkitURL,s=new AudioContext,console.log("Audio context set up."),console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(e){return alert("No web audio support in this browser!"),g=l.initFailed}u=e,navigator.getUserMedia({audio:!0},b,function(e){console.log("No live audio input: "+e),g=l.initFailed})}(e)}a.findHighestZIndex=m,a.audioMessage=p},function(e,o,t){"use strict";function n(e,o,t){var n=new Date;n.setDate(n.getDate()+t),document.cookie=e+"="+escape(o)+(null==t?"":"; expires="+n.toUTCString())}o.__esModule=!0,o.getCookie=function(e){if(0<document.cookie.length){var o=document.cookie.indexOf(e+"=");if(-1!=o){o=o+e.length+1;var t=document.cookie.indexOf(";",o);return-1==t&&(t=document.cookie.length),unescape(document.cookie.substring(o,t))}}return""},o.setCookie=n,o.delCookie=function(e){n(e,"",-1)}},function(e,o,t){"use strict";o.__esModule=!0;var i=t(0),l=t(1),r=t(2),a=t(4);o.dispatchResultFormSocketServer=function(e){switch(e.cmd){case l.GlobalCode.Response_login_code:i.GlobalVars2.globalMessageArray.push(e),console.log("push "+e);break;case l.GlobalCode.Response_mine_code:var o=e,t=i.GlobalVars2.globalLayImObj.cache();t.mine.id=o.id.toLocaleString(),t.mine.avatar=o.avatar,t.mine.username=o.username,t.mine.sign=o.sign,$(".layui-layim-user").html(t.mine.username),$(".layui-layim-remark").val(t.mine.sign);break;case l.GlobalCode.Response_add_friend_list_code:o=e;e.id=o.id.toString(),i.GlobalVars2.globalFriendsId.push(o.id),i.GlobalVars2.globalLayImObj.addList(e);break;case l.GlobalCode.Response_server_to_a_add_friend_code:case l.GlobalCode.Response_server_to_a_fetch_friend_code:i.GlobalVars2.globalMessageArray.push(e),console.log("push "+e.cmd+e);break;case l.GlobalCode.Response_message_code:i.GlobalVars2.globalLayImObj.getMessage(e);var n=new r.AckChatMessage;n.cmd=l.GlobalCode.Requst_ack_message_code,n.gid=e.gid,i.sendMessageToServer(n);break;case l.GlobalCode.Response_friend_status_change_code:o=e;i.GlobalVars2.globalLayImObj.setFriendStatus(o.id,o.status);break;case l.GlobalCode.Request_server_to_b_add_friend_code:case l.GlobalCode.Response_video_chat_server_to_a_code:case l.GlobalCode.Response_video_chat_server_to_b_code:i.GlobalVars2.globalMessageArray.push(e);break;case l.GlobalCode.Response_server_to_client_video_was_stopped_code:!function(e){if(!a.GlobalVars3.GlobalVideoSystem.equalLocalSession(e.localsession))return;$("#remotemessage").html("对方已经挂机！！"),$("#remotemessage").css("color","red")}(o=e);break;case l.GlobalCode.Response_remove_friend_code:o=e;i.GlobalVars2.globalLayImObj.removeList({type:"friend",id:o.friendid});break;default:console.log("unknow command",e.cmd,e)}},o.removeThisFriend=function(e){var o,t=$(e).attr("data-json"),n=decodeURIComponent(t),a=JSON.parse(n);o='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;"> 你确定要删除 这位好友吗？',o+='<table class="layui-table"  style="background-color: #393D49;">',o+=" <colgroup>",o+='  <col width="150">',o+=' <col width="200">',o+=" <col>",o+="</colgroup>",o+="<thead>",o+='<tr style="background-color: #393D49;">',o+="<th>昵称</th>",o+="<th>头像</th>",o+="<th>签名</th>",o+="</tr>",o+="</thead>",o+="<tbody>",o+="<tr>",o+="<td> "+a.name+"</td>",o+='<td><img style="width: 150px; height:150px;" src="'+a.avatar+'"></td>',o+="<td> "+a.remark+" </td>",o+="   </tr>",o+="</tbody>",o+="</table>",o+=" </div>";var s=new r.RequestRemoveFriend;s.cmd=l.GlobalCode.Request_remove_friend_code,s.friendid=parseInt(a.id,10),i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["删除用户","还是保留吧"],btnAlign:"c",moveType:1,content:o,yes:function(e,o){i.sendMessageToServer(s),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)},btn2:function(e,o){i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}})}},function(e,o,t){"use strict";o.__esModule=!0;var n=t(0),a=t(4),s=t(1);o.videoChat=function(e){if(!n.audioorvideoWorking()&&!a.GlobalVars3.GlobalVideoSystem.isFirstVideoChatInited()){a.GlobalVars3.GlobalVideoSystem.createFirstVideoChat(e,!1);var o=a.GlobalVars3.GlobalVideoSystem.getSingalVideoChat();o.cmd=s.GlobalCode.Request_video_chat_a_to_server_code,n.sendMessageToServer(o),a.showCallPage()}},o.makeacall=function(e){if(!n.audioorvideoWorking()&&!a.GlobalVars3.GlobalVideoSystem.isFirstVideoChatInited()){a.GlobalVars3.GlobalVideoSystem.createFirstVideoChat(e,!0);var o=a.GlobalVars3.GlobalVideoSystem.getSingalVideoChat();o.cmd=s.GlobalCode.Request_video_chat_a_to_server_code,o.audiochatonly=!0,n.sendMessageToServer(o),a.showCallPage()}}},function(e,o,t){"use strict";o.__esModule=!0;var i=t(0),l=t(1),a=t(2),r=t(4);o.coreMessageLoop=function n(){setTimeout(function(){if(i.isProcessCoreMessageWorking())if(0!=i.GlobalVars2.globalMessageArray.length){var e=i.GlobalVars2.globalMessageArray.pop();switch(i.stopProcessCoreMessage(),console.log("pop "+e.cmd+" "+JSON.stringify(e)+" "),e.cmd){case l.GlobalCode.Response_login_code:var o=e;"success"!=o.result&&(alert("登录失败了， "+o.result),window.location.href=i.GlobalVars2.globalLoginPage),i.startProcessCoreMessage();break;case l.GlobalCode.Response_server_to_a_add_friend_code:!function(n){var e;e='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">',e+=" 收到  信息",e+=" 用户： "+n.fromname,e+='       <img style="width: 150px; height:150px;" src="'+n.fromavatar+'">   </br>',1==n.result?e+="       同意了加好友的请求 </br>":e+="       拒绝了加好友的请求   </br>",e+=" </div>",i.GlobalVars2.globalLayImObj,i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["关闭"],btnAlign:"c",moveType:1,content:e,yes:function(e,o){var t=new a.AckChatMessage;t.cmd=l.GlobalCode.Requst_ack_message_code,t.gid=n.gid,i.sendMessageToServer(t),i.GlobalVars2.Global_layer.close(e),i.startProcessCoreMessage()}})}(e);break;case l.GlobalCode.Request_confirm_add_friend_code:break;case l.GlobalCode.Response_server_to_a_fetch_friend_code:!function(e){0==e.result?i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["退出"],btnAlign:"c",moveType:1,content:"对不起，该位用户没有找到",yes:function(e,o){i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}}):function(n){var e;e='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">',e+=" 收到 用户的信息",e+='<table class="layui-table"  style="background-color: #393D49;">',e+=" <colgroup>",e+='  <col width="150">',e+=' <col width="200">',e+=" <col>",e+="</colgroup>",e+="<thead>",e+='<tr style="background-color: #393D49;">',e+="<th>昵称</th>",e+="<th>头像</th>",e+="<th>签名</th>",e+="</tr>",e+="</thead>",e+="<tbody>",e+="<tr>",e+="<td> "+n.userInfo.Nickname+"</td>",e+='<td><img style="width: 150px; height:150px;" src="'+n.userInfo.Avatar+'"></td>',e+="<td>"+n.userInfo.Sign+"</td>",e+="   </tr>",e+="</tbody>",e+="</table>",e+="想对他说什么？ <br>   ",e+='   <div class="layui-form-item"> ',e+='    <div class="layui-input-block"> ',e+='    <input type="text" id="add_frend_contant" required  lay-verify="required" ',e+=' placeholder="想对他说什么" autocomplete="off" class="layui-input"  style="width:190px;">',e+="    </div> ",e+="    </div> ",e+=" </div>",i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["请求加好友","放弃加好友"],btnAlign:"c",moveType:1,content:e,yes:function(e,o){i.GlobalVars2.globalLayImObj.cache();var t=new a.AddFriendRequest;t.cmd=l.GlobalCode.Request_a_to_server_add_friend_code,t.ifromid=i.GlobalVars2.globalUserID,t.itoid=n.userInfo.Id,t.remark=$("#add_frend_contant").val(),i.sendMessageToServer(t),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)},btn2:function(e,o){i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}})}(e)}(e);break;case l.GlobalCode.Request_server_to_b_add_friend_code:!function(e){var o;o='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;"> 收到 用户的信息',o+='<table class="layui-table"  style="background-color: #393D49;">',o+=" <colgroup>",o+='  <col width="150">',o+=' <col width="200">',o+=" <col>",o+="</colgroup>",o+="<thead>",o+='<tr style="background-color: #393D49;">',o+="<th>昵称</th>",o+="<th>头像</th>",o+="<th>签名</th>",o+="</tr>",o+="</thead>",o+="<tbody>",o+="<tr>",o+="<td> "+e.fromname+"</td>",o+='<td><img style="width: 150px; height:150px;" src="'+e.fromavatar+'"></td>',o+="<td> </td>",o+="   </tr>",o+="</tbody>",o+="</table>",o+=" 希望加你为好友 "+e.remark+"  <br>",o+="     ",o+=" </div>";var t=i.GlobalVars2.globalLayImObj.cache(),n=new a.AddFriendResponse;n.cmd=l.GlobalCode.Request_confirm_add_friend_code,n.ifromid=parseInt(t.mine.id,10),n.itoid=e.ifromid,n.recvsidegid=e.recvsidegid,n.fromsidegid=e.fromsidegid,console.log("confirm_Request_server_to_b_add_friend: ",JSON.stringify(n)),i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["同意加好友","不同意加好友"],btnAlign:"c",moveType:1,content:o,yes:function(e,o){n.result=!0,i.sendMessageToServer(n),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)},btn2:function(e,o){n.result=!1,i.sendMessageToServer(n),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}})}(e);break;case l.GlobalCode.Response_video_chat_server_to_a_code:!function(e){return r.GlobalVars3.GlobalVideoSystem.equalLocalSession(e.localsession)?1==e.result?(r.GlobalVars3.GlobalVideoSystem.updateMyFirstVideoChat(e),r.callVeidoSingalServer(e),i.startProcessCoreMessage()):(r.hideCallPage(),r.GlobalVars3.GlobalVideoSystem.cleanLocalSession(),o='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">',o+=" 好友 ",o+="拒绝",o+="你的视频要求<br/> ",""!=e.description&&(o+=e.description+"<br/>"),o+=" </div>",i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["知道了"],btnAlign:"c",moveType:1,content:o,yes:function(e,o){i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}})):i.startProcessCoreMessage();var o}(e);break;case l.GlobalCode.Response_video_chat_server_to_b_code:var t=e;!function(t){if(console.log("process_Response_video_chat_server_to_b :",t),console.log("constructor VideoSystemObj :",r.GlobalVars3.GlobalVideoSystem.snid),r.GlobalVars3.GlobalVideoSystem.isFirstVideoChatInited()){var e=t;return e.cmd=l.GlobalCode.Request_video_chat_b_to_server_code,e.result=!1,e.description="对方很忙",i.sendMessageToServer(e),i.startProcessCoreMessage()}for(var o,n=!1,a=0;a<i.GlobalVars2.globalFriendsId.length;a++)if(i.GlobalVars2.globalFriendsId[a]==t.clienta){n=!0;break}return t.clienta==i.GlobalVars2.globalUserID?i.startProcessCoreMessage():t.clientb!=i.GlobalVars2.globalUserID?i.startProcessCoreMessage():0==n?((s=t).cmd=l.GlobalCode.Request_video_chat_b_to_server_code,s.result=!1,s.description="对方并不想和陌生人聊天",i.sendMessageToServer(s),i.startProcessCoreMessage()):(o='<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">',o+=" 收到 "+t.fromname+"<br/>",o+='<img src="'+t.fromavatar+"\"  width='190px'  height='190px'>发来的视频聊天请求， 请选择<br/> </div>",(s=t).cmd=l.GlobalCode.Request_video_chat_b_to_server_code,i.GlobalVars2.Global_layer.open({type:1,title:!1,closeBtn:!1,area:i.getOpenWidth(),shade:.8,btn:["同意视频","残忍拒绝"],btnAlign:"c",moveType:1,content:o,yes:function(e,o){s.result=!0,i.sendMessageToServer(s),r.GlobalVars3.GlobalVideoSystem.updateMyFirstVideoChat(s),r.showCallPage(),r.callVeidoSingalServer(t),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)},btn2:function(e,o){s.result=!1,i.sendMessageToServer(s),i.startProcessCoreMessage(),i.GlobalVars2.Global_layer.close(e)}}));var s}(t);break;default:alert(JSON.stringify(t))}n()}else n();else n()},i.GlobalVars2.CoreMessageLoopTime)}},,,,,,,function(e,o,t){var n,a;n=[t,o,t(0),t(2),t(3),t(1),t(7),t(6),t(9),t(4),t(8),t(5)],void 0===(a=function(e,o,n,a,t,s,i,l,r,c,d,u){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),window.onload=function(){document.oncontextmenu=function(){return!1},n.changeBackground(),localStorage.removeItem("layim"),n.GlobalVars2.globalUserID=parseInt(l.getCookie("id"),10),n.GlobalVars2.globalPwd=l.getCookie("passwd"),l.delCookie("id"),l.delCookie("passwd"),0!=n.GlobalVars2.globalUserID&&""!=n.GlobalVars2.globalPwd||(alert("登录失效了， 请重新登录！！"),window.location.href=n.GlobalVars2.globalLoginPage),window.removeThisFriend=i.removeThisFriend,window.videoChat=d.videoChat,window.makeacall=d.makeacall,window.audioMessage=u.audioMessage,c.GlobalVars3.GlobalVideoSystem=new c.VideoSystemObj,r.coreMessageLoop(),console.log(" InitLayImSystem  "),layui.use("layim",function(o){o.config({init:{url:"../json/mine.json",data:{}}}),o.on("ready",function(e){n.GlobalVars2.globalImSocketObject=new WebSocket(t.GlobalVars.ImServer),n.GlobalVars2.globalLayImObj=o,n.GlobalVars2.Global_layim=o,n.GlobalVars2.Global_layer=layer,n.GlobalVars2.globalImSocketObject.onopen=function(){console.log("user: "+n.GlobalVars2.globalUserID+" connect success. "+t.GlobalVars.ImServer);var e=new a.RequsetSignin;e.cmd=s.GlobalCode.Request_login_code,e.id=n.GlobalVars2.globalUserID,e.passwd=n.GlobalVars2.globalPwd,n.sendMessageToServer(e)},n.GlobalVars2.globalImSocketObject.onclose=function(e){n.GlobalVars2.Global_layer.open({content:"和服务器的连接断开了，请重新刷新登录系统！谢谢！",btn:["知道了"],yes:function(e,o){n.GlobalVars2.Global_layer.close(e),window.location.href=n.GlobalVars2.globalLoginPage}}),console.log("user: "+n.GlobalVars2.globalUserID+" connect closed")},n.GlobalVars2.globalImSocketObject.onmessage=function(o){console.log("websocket recv:"+o.data);var e="";try{e=JSON.parse(o.data)}catch(e){return void console.log("parse json failed",e,"res.data",o.data)}i.dispatchResultFormSocketServer(e)},o.on("sign",function(e){console.log(e)}),o.on("sendMessage",function(e){e.cmd=s.GlobalCode.Request_message_code;var o=new a.ChatMessage;o.cmd=s.GlobalCode.Request_message_code,o.username=e.mine.username,o.avatar=e.mine.avatar,o.gid=0,o.fromid=e.mine.id,o.id=e.mine.id,o.toid=e.to.id,o.cid=0,o.type="friend",o.mine=!1,o.content=e.mine.content,o.timestamp=(new Date).valueOf(),n.sendMessageToServer(o)}),$("#find_friend").click(function(){n.GlobalVars2.Global_layer.open({content:'查找好友 <br/><br/><div class="layui-form-item"><label class="layui-form-label">查找ID</label><div class="layui-input-block"><input type="text" id="search_id" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input"></div></div>',btn:["查找"],yes:function(e,o){var t=new a.RequestFetchFriendInfo;t.cmd=s.GlobalCode.Request_fetch_friend_code,t.friendid=parseInt($("#search_id").val(),10),n.sendMessageToServer(t),n.GlobalVars2.Global_layer.close(e)},cancel:function(e,o){n.GlobalVars2.Global_layer.close(e)}})})})}),c.initVideoSystem()}}.apply(o,n))||(e.exports=a)}]);
//# sourceMappingURL=main_pc.js.map